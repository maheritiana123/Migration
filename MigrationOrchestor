public class MigrationOrchestrator
{
Â  Â  private readonly HashSet<string> _pureRelations;
Â  Â  private readonly HashSet<string> _extendedRelations;
Â  Â  private readonly HashSet<string> _importedTables = new();
Â  Â  private readonly Dictionary<string, Dictionary<string, string>> _idMappings;

Â  Â  private readonly Func<string, List<ForeignKeyInfo>> _getForeignKeyInfo;
Â  Â  private readonly Action<string> _importTable;
Â  Â  private readonly Action<string> _importPureRelationTable;
Â  Â  private readonly Action<string> _importExtendedRelationTable;
Â  Â  private readonly Func<List<string>> _getAllTables;

Â  Â  public MigrationOrchestrator(
Â  Â  Â  Â  HashSet<string> pureRelations,
Â  Â  Â  Â  HashSet<string> extendedRelations,
Â  Â  Â  Â  Dictionary<string, Dictionary<string, string>> idMappings,
Â  Â  Â  Â  Func<string, List<ForeignKeyInfo>> getForeignKeyInfo,
Â  Â  Â  Â  Action<string> importTable,
Â  Â  Â  Â  Action<string> importPureRelationTable,
Â  Â  Â  Â  Action<string> importExtendedRelationTable,
Â  Â  Â  Â  Func<List<string>> getAllTables)
Â  Â  {
Â  Â  Â  Â  _pureRelations = pureRelations;
Â  Â  Â  Â  _extendedRelations = extendedRelations;
Â  Â  Â  Â  _idMappings = idMappings;
Â  Â  Â  Â  _getForeignKeyInfo = getForeignKeyInfo;
Â  Â  Â  Â  _importTable = importTable;
Â  Â  Â  Â  _importPureRelationTable = importPureRelationTable;
Â  Â  Â  Â  _importExtendedRelationTable = importExtendedRelationTable;
Â  Â  Â  Â  _getAllTables = getAllTables;
Â  Â  }

Â  Â  private class TableImportInfo
Â  Â  {
Â  Â  Â  Â  public string Name { get; set; }
Â  Â  Â  Â  public bool IsPureRelation { get; set; }
Â  Â  Â  Â  public bool IsExtendedRelation { get; set; }
Â  Â  Â  Â  public List<string> ForeignKeys { get; set; }
Â  Â  }

Â  Â  public void PerformGlobalImport()
Â  Â  {
Â  Â  Â  Â  var graph = BuildImportGraph();
Â  Â  Â  Â  var ordered = GetOrderedImportList(graph);
Â  Â  Â  Â  ImportAllInOrder(ordered);
Â  Â  }

Â  Â  private List<TableImportInfo> BuildImportGraph()
Â  Â  {
Â  Â  Â  Â  var result = new List<TableImportInfo>();
Â  Â  Â  Â  var allTables = _getAllTables();

Â  Â  Â  Â  foreach (var table in allTables)
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  result.Add(new TableImportInfo
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Name = table,
Â  Â  Â  Â  Â  Â  Â  Â  IsPureRelation = _pureRelations.Contains(table),
Â  Â  Â  Â  Â  Â  Â  Â  IsExtendedRelation = _extendedRelations.Contains(table),
Â  Â  Â  Â  Â  Â  Â  Â  ForeignKeys = _getForeignKeyInfo(table).Select(fk => fk.ReferencedTableName).ToList()
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  return result;
Â  Â  }

Â  Â  private List<TableImportInfo> GetOrderedImportList(List<TableImportInfo> graph)
Â  Â  {
Â  Â  Â  Â  var ordered = new List<TableImportInfo>();
Â  Â  Â  Â  var visited = new HashSet<string>();
Â  Â  Â  Â  var tempMark = new HashSet<string>();
Â  Â  Â  Â  var pathStack = new Stack<string>();
Â  Â  Â  Â  var cycles = new List<List<string>>();

Â  Â  Â  Â  void Visit(TableImportInfo table)
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  if (visited.Contains(table.Name)) return;

Â  Â  Â  Â  Â  Â  if (tempMark.Contains(table.Name))
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  var cycle = pathStack.Reverse().TakeWhile(t => t != table.Name).Reverse().ToList();
Â  Â  Â  Â  Â  Â  Â  Â  cycle.Add(table.Name);
Â  Â  Â  Â  Â  Â  Â  Â  Console.WriteLine("ğŸ” Cycle dÃ©tectÃ© : " + string.Join(" â ", cycle));
Â  Â  Â  Â  Â  Â  Â  Â  cycles.Add(cycle);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  tempMark.Add(table.Name);
Â  Â  Â  Â  Â  Â  pathStack.Push(table.Name);

Â  Â  Â  Â  Â  Â  foreach (var fk in table.ForeignKeys)
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  var dep = graph.FirstOrDefault(t => t.Name == fk);
Â  Â  Â  Â  Â  Â  Â  Â  if (dep != null)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Visit(dep);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  pathStack.Pop();
Â  Â  Â  Â  Â  Â  tempMark.Remove(table.Name);
Â  Â  Â  Â  Â  Â  visited.Add(table.Name);
Â  Â  Â  Â  Â  Â  ordered.Add(table);
Â  Â  Â  Â  }

Â  Â  Â  Â  foreach (var table in graph)
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Visit(table);
Â  Â  Â  Â  }

Â  Â  Â  Â  if (cycles.Count > 0)
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Console.WriteLine("âš ï¸ Cycle(s) dÃ©tectÃ©(s) : " + cycles.Count);
Â  Â  Â  Â  }

Â  Â  Â  Â  return ordered;
Â  Â  }

Â  Â  private void ImportAllInOrder(List<TableImportInfo> importList)
Â  Â  {
Â  Â  Â  Â  var remaining = new List<TableImportInfo>(importList);
Â  Â  Â  Â  int pass = 1;

Â  Â  Â  Â  while (remaining.Count > 0)
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  var skipped = new List<TableImportInfo>();
Â  Â  Â  Â  Â  Â  Console.WriteLine($"\nğŸš€ Pass {pass} : {remaining.Count} table(s) Ã  importer");

Â  Â  Â  Â  Â  Â  foreach (var table in remaining)
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  if (_importedTables.Contains(table.Name)) continue;

Â  Â  Â  Â  Â  Â  Â  Â  bool ready = table.ForeignKeys.All(fk => _idMappings.ContainsKey(fk));
Â  Â  Â  Â  Â  Â  Â  Â  if (!ready)
Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Console.WriteLine($"[WAIT] {table.Name} - FK manquantes");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  skipped.Add(table);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Console.WriteLine($"[IMPORT] {table.Name}");

Â  Â  Â  Â  Â  Â  Â  Â  if (table.IsPureRelation)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  _importPureRelationTable(table.Name);
Â  Â  Â  Â  Â  Â  Â  Â  else if (table.IsExtendedRelation)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  _importExtendedRelationTable(table.Name);
Â  Â  Â  Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  _importTable(table.Name);

Â  Â  Â  Â  Â  Â  Â  Â  _importedTables.Add(table.Name);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (skipped.Count == remaining.Count)
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Console.WriteLine("âŒ Aucun progrÃ¨s possible Ã  cette passe. Import bloquÃ©.");
Â  Â  Â  Â  Â  Â  Â  Â  foreach (var table in skipped)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Console.WriteLine($" - {table.Name}");
Â  Â  Â  Â  Â  Â  Â  Â  throw new Exception("Import Ã©chouÃ© : dÃ©pendances FK non satisfaites.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  remaining = skipped;
Â  Â  Â  Â  Â  Â  pass++;
Â  Â  Â  Â  }

Â  Â  Â  Â  Console.WriteLine("\nâœ… Import global terminÃ© !");
Â  Â  }
}