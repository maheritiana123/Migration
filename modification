-- 4) INSERT : version SCOPE_IDENTITY() via param OUTPUT (1 ID par ligne, garanti)
DECLARE @sql nvarchar(max);
SET @sql = N'SET NOCOUNT ON; '
         + N'INSERT INTO ' + QUOTENAME(@TableName) + N' (' + @Columns + N') '
         + N'SELECT ' + @values + N'; '
         + N'SET @nid = CONVERT(nvarchar(100), SCOPE_IDENTITY());';

BEGIN TRY
    DECLARE @newId nvarchar(100) = NULL;  -- réinitialisé à chaque ligne
    EXEC sp_executesql
        @sql,
        N'@nid nvarchar(100) OUTPUT',
        @nid = @newId OUTPUT;

    IF @newId IS NULL OR @newId = N''
    BEGIN
        INSERT INTO @out(RowIndex, NewID, ErrorMessage)
        VALUES(@rowIdx, NULL, N'ERR: aucune ligne insérée (SCOPE_IDENTITY() vide) | vals=' + @values);
    END
    ELSE
    BEGIN
        INSERT INTO @out(RowIndex, NewID, ErrorMessage)
        VALUES(@rowIdx, @newId, NULL);
    END
END TRY
BEGIN CATCH
    INSERT INTO @out(RowIndex, NewID, ErrorMessage)
    VALUES(@rowIdx, NULL, N'ERR: ' + ERROR_MESSAGE() + N' | vals=' + @values);
END CATCH