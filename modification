-- DEBUG: montrer la clé normale utilisée pour la détection
DECLARE @keyDebug NVARCHAR(MAX) = N'';
SELECT @keyDebug = STRING_AGG(
         QUOTENAME(c.ColName) + N'=' +
         CASE WHEN UPPER(a.Val) = 'NULL' THEN 'NULL' ELSE a.Val END
       , N' , '
       ) WITHIN GROUP (ORDER BY c.Ord)
FROM @colList c
JOIN @aligned a ON a.Ord = c.Ord
WHERE c.ColName IN (
    SELECT LTRIM(RTRIM(REPLACE(REPLACE(p.value,'[',''),']','')))
    FROM STRING_SPLIT(@pkCols, ',') p
);

PRINT N'[DEBUG] Row ' + CAST(@i AS NVARCHAR(10)) 
    + N' | WHERE=' + @whereClause 
    + N' | KEY=' + @keyDebug;